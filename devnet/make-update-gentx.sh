#! /usr/bin/sh
# make-update-gentx.sh uses node1 as a starting point and adds
# genesis txs generated by nodes 2 and 3 to its data directory.
# It then collects all these txs and generates the final genesis.json file
#
# The resulting genesis.json is then copied back into nodes 2 and 3.

set -e

AMOUNT="100000000000sourcebucks"
PATH="/app/build:$PATH"
STATE_DIR="/root/sourcehub"

if [ -e $STATE_DIR/GENESIS_BUILT ];
then
    echo "Genesis Tx already collected"
    return 0;
fi

echo 'Fetching Validators addresses'
VALIDATOR2_ADDR="$(cat /root/node2/validator-addr)"
VALIDATOR3_ADDR="$(cat /root/node3/validator-addr)"
echo "Validator 2: $VALIDATOR2_ADDR"
echo "Validator 3: $VALIDATOR3_ADDR"

echo 'Adding Validator Accounts'
sourcehubd genesis add-genesis-account $VALIDATOR2_ADDR $AMOUNT --home $STATE_DIR
sourcehubd genesis add-genesis-account $VALIDATOR3_ADDR $AMOUNT --home $STATE_DIR

cp /root/node2/config/gentx/* /root/sourcehub/config/gentx/
cp /root/node3/config/gentx/* /root/sourcehub/config/gentx/

sourcehubd genesis collect-gentxs --home $STATE_DIR
touch /root/sourcehub/GENESIS_BUILT

# Mission critical step: make the sourcebucks
sed -i 's/stake/sourcebucks/g' /root/sourcehub/config/genesis.json

cp /root/sourcehub/config/genesis.json /root/node2/config/
cp /root/sourcehub/config/genesis.json /root/node3/config/

echo 'GenesisTx generated'
